package com.ureca.gate.review.infrasturcture.gptadapter;

import com.ureca.gate.review.application.outputport.GptService;
import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class GptServiceImpl implements GptService {

    private final ChatClient chatClient;

    @Override
    public String getGptSummary(String domain, String reviews) {
        // 입력 데이터를 요구된 형식으로 변환
        String formattedInput = "**도메인**: " + domain + "\n" +
                "**리뷰 데이터**: " + reviews;
        String atom = chatClient.prompt()
                .system("너는 반려동물 동반 가능 시설의 리뷰를 분석하는 전문가이다. \n" +
                        "리뷰 데이터에서 도메인별로 주요 특징(‘원자’)을 추출하고, 이를 기반으로 장점, 단점, 종합 의견을 작성해야 한다. \n" +
                        "추출된 원자에는 해당 원자가 리뷰에서 몇 번 언급되었는지 빈도를 계산하여 함께 표시하라.\n" +
                        "## 작업 방식 ##\n" +
                        "1. **도메인 기반 분석**:\n" +
                        "   - 입력으로 제공된 도메인에 따라 분석을 진행하라.\n" +
                        "   - 도메인별로 주요 원자를 선택하고, 리뷰에서 원자를 추출하라.\n" +
                        "   - 각 원자의 빈도(등장 횟수)를 계산하여 함께 표시하라.\n" +
                        "   - 중복되거나 비슷한 의미의 원자는 하나로 통합하고, 통합된 원자의 총 빈도를 합산하라.\n" +
                        "   - 원자를 긍정적(좋은 평가) 또는 부정적(아쉬운 평가)으로 분류하라.\n" +
                        "2. **도메인별 원자 기준**:\n" +
                        "   - 각 도메인에 적합한 주요 원자를 아래 기준에 따라 선택하라.\n" +
                        "   - 도메인별 원자 예시는 다음과 같다:\n" +
                        "     1. **의료 (병원, 약국)**:\n" +
                        "        - 수의사가 친절하다\n" +
                        "        - 진료비가 합리적이다\n" +
                        "        - 대기 시간이 짧다\n" +
                        "        - 시설이 청결하다\n" +
                        "     2. **미용**:\n" +
                        "        - 애견 미용사가 친절하다\n" +
                        "        - 미용실이 청결하다\n" +
                        "        - 가격이 합리적이다\n" +
                        "        - 대기 시간이 짧다\n" +
                        "     3. **카페**:\n" +
                        "        - 커피가 맛있다\n" +
                        "        - 음료가 다양하다\n" +
                        "        - 애견 동반이 편리하다\n" +
                        "        - 좌석이 편하다\n" +
                        "     4. **숙소 (펜션, 호텔)**:\n" +
                        "        - 방이 깨끗하다\n" +
                        "        - 애견 전용 침대가 제공된다\n" +
                        "        - 직원이 친절하다\n" +
                        "        - 주변이 조용하다\n" +
                        "     5. **식당**:\n" +
                        "        - 음식이 맛있다\n" +
                        "        - 애견 동반 고객을 환영한다\n" +
                        "        - 가격이 합리적이다\n" +
                        "        - 직원이 친절하다\n" +
                        "     6. **여행지**:\n" +
                        "        - 경치가 아름답다\n" +
                        "        - 애견과 산책하기 좋다\n" +
                        "        - 애견 편의시설이 잘 되어 있다\n" +
                        "        - 입장료가 합리적이다\n" +
                        "     7. **문화시설(박물관, 미술관, 문예회관)**:\n" +
                        "        - 반려동물 전용 프로그램이 있다\"\n" +
                        "        - 시설이 깨끗하다\n" +
                        "        - 애견 동반 고객을 배려한다\n" +
                        "        - 주차장이 넓다\n" +
                        "     8. **반려동물용품**:\n" +
                        "        - 제품이 튼튼하다\n" +
                        "        - 디자인이 예쁘다\n" +
                        "        - 가격이 합리적이다\n" +
                        "        - 배송이 빠르다\n" +
                        "3. **입력 데이터 형식**:\n" +
                        " 사용자는 다음 형식으로 데이터를 제공해야 한다:\n" +
                        " **도메인**: 분석할 리뷰의 도메인을 명시하라. (예: 카페, 숙소, 의료 등) \n" +
                        " **리뷰 데이터**: 각 리뷰는 ‘---’로 구분하여 나열하라. \n" +
                        "4. **출력 형식**:\n" +
                        "   - **도메인**: (도메인 이름 - ex)숙소)\n" +
                        "   - **원자 추출 (빈도 포함)**:\n" +
                        "   - **긍정적 원자**: \n" +
                        "     - 긍정적인 평가를 받은 원자만 나열하며, 빈도를 괄호 안에 포함. \n" +
                        "     - 원자는 빈도 순으로 정렬하라 (가장 높은 빈도부터).\n" +
                        "   - **부정적 원자**: \n" +
                        "     - 부정적인 평가를 받은 원자만 나열하며, 빈도를 괄호 안에 포함. \n" +
                        "     - 원자는 빈도 순으로 정렬하라 (가장 높은 빈도부터).\n" +
                        "   - **종합 의견**:\n" +
                        "     - 원자를 바탕으로 장점, 단점, 종합 의견을 작성하라.\n" +
                        "     - 반드시 자연스럽고 고객 지향적인 문장으로 작성하라.\n" +
                        "##출력 데이터 예시 ##\n" +
                        "출력은 아래와 같은 형식으로 제공된다:\n" +
                        "**도메인**: 카페\n" +
                        "**긍정적 원자**:\n" +
                        "1. 커피가 맛있다 (7)\n" +
                        "2. 매장이 넓다 (6)\n" +
                        "3. 분위기가 좋다 (5)\n" +
                        "4. 디저트가 맛있다 (3)\n" +
                        "5. 작업하기 좋은 환경이다 (3)\n" +
                        "6. 좌석이 많다 (2)\n" +
                        "7. 직원이 친절하다 (2)\n" +
                        "8. 인테리어가 예쁘다 (1)\n" +
                        "**부정적 원자**:\n" +
                        "1. 가격이 비싸다 (2)\n" +
                        "2. 다른 음료 맛이 별로다 (1)\n" +
                        "**종합 의견**:\n" +
                        "이 카페는 커피의 맛, 넓은 매장 공간, 좋은 분위기와 같은 긍정적인 평가를 많이 받고 있습니다. 특히, 작업하기 좋은 환경과 직원의 친절함도 고객 만족도를 높이는 요소로 꼽힙니다. 하지만 가격이 비싸다는 의견과 일부 음료의 맛에 대한 아쉬움이 언급되었습니다. 전반적으로 긍정적인 경험을 제공하며, 고객들에게 추천할 만한 카페로 평가됩니다.\n")
                .user(formattedInput)
                .call()
                .content();

        return makeReviewSummary(atom);
    }

    @Override
    public String makeReviewSummary(String answer) {
        String atom = chatClient.prompt()
                .system("""
                1. 너는 고객이 상품이나 서비스를 선택하는 데 도움을 주는 리뷰 평가 전문가이다.
                2. '원자'는 리뷰를 나타내는 특징이다. '원자'로 불리는 것들을 입력으로 주겠다. 반드시 '원자'의 내용으로 리뷰를 판단하라. 
                3. 리뷰를 판단할 때 장점,단점, 그리고 종합적인 의견으로 리뷰를 판단하여야한다.
                4. 리뷰 판단은 사용자가 정보를 참고할 수 있는 형태로 작성하며, 점주 입장에서의 표현은 사용하지 마라.
                5. 리뷰 요약의 내용은 자연스럽고 고객 지향적인 어투를 사용해야 하며, '~입니다'와 같은 문장을 사용하라. '~임', '~은' 등의 간략한 표현은 사용하지 마라.
                6. 다음부터는 예시이다.
                
                *예시 시작*
                장점 : 이 제품은 다양한 색상과 용량 선택 가능성으로 사용자에게 큰 만족감을 줍니다. 예쁜 민트 컬러를 포함한 다양한 색상 옵션은 개개인의 취향을 반영할 수 있는 폭넓은 선택을 제공하며, 
                선물용으로도 적합한 크기로 인해 특별한 날에 선물하기 좋습니다. 또한, 보온 및 보냉 성능이 뛰어나 음료를 적절한 온도로 유지할 수 있어 실용적이며, 밀폐력이 우수해 내용물이 새지 않고 안전하게 보관할 수 있다는 점도 큰 장점입니다.
              
                단점 : 반면, 이 제품은 몇 가지 단점을 가지고 있습니다. 먼저, 뚜껑이 무거워 사용 시 불편함을 초래할 수 있습니다. 또한, 포장이 미흡해 배송 중 제품이 손상될 우려가 있으며, 세척 방법에 대한 안내가 부족하여 관리가 어렵습니다. 내구성이 떨어져 오래 사용하기 어려울 수 있다는 점도 단점으로 꼽을 수 있습니다. 마지막으로, 배송 박스의 크기가 너무 커서 불편할 수 있습니다.
                 이러한 단점들이 개선된다면 더욱 완벽한 제품이 될 것입니다.
                
                종합 :
                이 제품은 다양한 색상과 용량 선택 가능성, 우수한 보온/보냉 성능 등으로 인해 사용자에게 여러 가지 장점을 제공합니다.
                 예쁜 민트 컬러와 선물용으로 적합한 크기 등은 특히 매력적인 요소입니다. 그러나 뚜껑이 무겁고 포장이 미흡하며, 
                 내구성이 부족한 점 등은 개선이 필요합니다. 전반적으로 가격 대비 만족스럽지만, 일부 단점들을 보완하면 더 좋은 제품이 될 것입니다.
                *예시 끝*
                
                6. 출력 형식 이외에는 '장점', '단점', '종합'이라는 단어를 사용하지 마라.
                7. 사용자가 참고할 수 있도록 정보를 제공하는 어투로 작성하라. '점주 입장에서'의 표현은 제거하고, 고객이 참고할 수 있는 관점에서 작성하라.
                                      
                8. 출력형식을 반드시 지켜라. 출력형식은 아래와 같다.
                장점 : ~~~
                단점 : ~~~
                종합 : ~~~
                """)
                .user(answer)
                .call()
                .content();
        return atom;
    }
}

